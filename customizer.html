// GitHub OAuth + API Integration (core logic)

const githubConfig = {
  client_id: "YOUR_GITHUB_CLIENT_ID",
  repo: "eid-cards",
  owner: "YOUR_GITHUB_USERNAME",
  filename: "config.js",
  branch: "main"
};

// 1. Redirect user to GitHub OAuth login
function loginWithGitHub() {
  const redirectUri = encodeURIComponent(window.location.href);
  window.location.href = `https://github.com/login/oauth/authorize?client_id=${githubConfig.client_id}&scope=repo&redirect_uri=${redirectUri}`;
}

// 2. Exchange code for access_token (on server or GitHub App proxy)
async function exchangeCodeForToken(code) {
  const response = await fetch(`/exchange-token?code=${code}`); // Requires backend or proxy function
  const data = await response.json();
  return data.access_token;
}

// 3. Update config.js in the user repository
async function uploadConfigToGitHub(token, content) {
  const api = `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.filename}`;

  // Step 1: Get SHA of existing file
  const existing = await fetch(api, {
    headers: { Authorization: `token ${token}` }
  });
  const existingData = await existing.json();
  const sha = existingData.sha;

  // Step 2: Upload new file
  const encodedContent = btoa(unescape(encodeURIComponent(content)));

  const result = await fetch(api, {
    method: "PUT",
    headers: {
      Authorization: `token ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: "üîß ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÑŸÅ ÿßŸÑÿ™ÿÆÿµŸäÿµ config.js",
      content: encodedContent,
      branch: githubConfig.branch,
      sha: sha
    })
  });

  return result.ok;
}

// Usage (after authentication):
// 1. Check if access_token exists
// 2. Generate config content from form
// 3. Call uploadConfigToGitHub(token, generatedContent)
