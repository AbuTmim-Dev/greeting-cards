<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>صفحة تخصيص منصة بطاقات التهنئة</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { direction: rtl; text-align: center; font-family: 'Tajawal', sans-serif; }
    input, select { padding: 6px; margin: 8px; max-width: 280px; width: 90%; }
    button { padding: 10px 20px; margin-top: 20px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>تخصيص منصة بطاقات التهنئة</h1>

  <div id="step1">
    <p>لتخصيص المنصة، يرجى تسجيل الدخول باستخدام حساب GitHub الخاص بك.</p>
    <button onclick="startDeviceFlow()">🔐 تسجيل الدخول إلى GitHub</button>
    <div id="deviceInfo" class="hidden">
      <p>يرجى زيارة: <a href="https://github.com/login/device" target="_blank">github.com/login/device</a></p>
      <p>وأدخل الكود التالي:</p>
      <h2 id="user_code"></h2>
    </div>
  </div>

  <div id="customizerForm" class="hidden">
    <h2>إعدادات التخصيص</h2>
    <label>اسم الجهة في الحقوق:</label><br>
    <input type="text" id="footerEntityName" value="جمعية فزعة للإغاثة بالزلفي"><br>

    <label>السنة في الحقوق:</label><br>
    <input type="text" id="footerYear" value="2025"><br>

    <label>عنوان الصفحة:</label><br>
    <input type="text" id="pageTitle" value="بطاقات العيد - كل عام وأنتم بخير"><br>

    <label>المناسبة (مثال: عيد الفطر):</label><br>
    <input type="text" id="occasionText" value="عيد الفطر"><br>

    <label>لون الخلفية:</label><br>
    <input type="color" id="backgroundColor" value="#f9f9f9"><br>

    <label>لون الأزرار:</label><br>
    <input type="color" id="buttonColor" value="#006699"><br>

    <label>عدد التصاميم:</label><br>
    <input type="number" id="designCount" value="6" min="1" max="20"><br>

    <button onclick="saveConfigToGitHub()">💾 حفظ التخصيص في GitHub</button>
  </div>

  <script>
    const client_id = "YOUR_CLIENT_ID"; // استبدلها بمعرف تطبيقك من GitHub
    let device_code = "";
    let access_token = "";
    let username = "";

    async function startDeviceFlow() {
      const res = await fetch("https://github.com/login/device/code", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `client_id=${client_id}&scope=repo`
      });
      const data = await res.json();
      device_code = data.device_code;
      document.getElementById("user_code").textContent = data.user_code;
      document.getElementById("deviceInfo").classList.remove("hidden");

      pollAccessToken(data.interval);
    }

    async function pollAccessToken(interval) {
      const poll = setInterval(async () => {
        const res = await fetch("https://github.com/login/oauth/access_token", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded", "Accept": "application/json" },
          body: `client_id=${client_id}&device_code=${device_code}&grant_type=urn:ietf:params:oauth:grant-type:device_code`
        });
        const data = await res.json();
        if (data.access_token) {
          clearInterval(poll);
          access_token = data.access_token;
          document.getElementById("customizerForm").classList.remove("hidden");
          document.getElementById("step1").classList.add("hidden");
          getUserInfo();
        }
      }, interval * 1000);
    }

    async function getUserInfo() {
      const res = await fetch("https://api.github.com/user", {
        headers: { Authorization: `token ${access_token}` }
      });
      const data = await res.json();
      username = data.login;
    }

    async function saveConfigToGitHub() {
      const config = {
        logoType: "image",
        logoImageHeight: 180,
        logoText: "جهة افتراضية",
        logoTextColor: "#006699",
        logoTextFont: "Tajawal",
        logoTextSize: 24,
        occasionText: document.getElementById("occasionText").value,
        pageTitle: document.getElementById("pageTitle").value,
        backgroundColor: document.getElementById("backgroundColor").value,
        buttonColor: document.getElementById("buttonColor").value,
        footerEntityName: document.getElementById("footerEntityName").value,
        footerYear: document.getElementById("footerYear").value,
        visitorBadgeBase: "eid99999-cards",
        enableVisitorBadge: true,
        designCount: parseInt(document.getElementById("designCount").value)
      };

      const content = `const config = ${JSON.stringify(config, null, 2)};`;
      const base64Content = btoa(unescape(encodeURIComponent(content)));

      const repo = "eid-cards"; // اسم الريبو المتوقع
      const file = "config.js";

      // نجيب SHA للملف
      const resMeta = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${file}`, {
        headers: { Authorization: `token ${access_token}` }
      });
      const meta = await resMeta.json();
      const sha = meta.sha;

      // تحديث الملف
      const resUpdate = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${file}`, {
        method: "PUT",
        headers: { Authorization: `token ${access_token}` },
        body: JSON.stringify({
          message: "تحديث إعدادات التخصيص من customizer.html",
          content: base64Content,
          sha: sha
        })
      });

      if (resUpdate.ok) {
        alert("✅ تم حفظ التخصيص بنجاح!");
      } else {
        alert("❌ حدث خطأ في الحفظ. تأكد من أن المشروع موجود باسم eid-cards داخل حسابك.");
      }
    }
  </script>
</body>
</html>
